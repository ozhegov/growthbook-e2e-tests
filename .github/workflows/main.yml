name: E2E Full Tests (main)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  full:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    env:
      BASE_URL: http://localhost:3000
      API_BASE_URL: http://localhost:3100
      STORAGE_DIR: storage

      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      ENGINEER_PASSWORD: ${{ secrets.ENGINEER_PASSWORD }}
      EXPERIMENTER_PASSWORD: ${{ secrets.EXPERIMENTER_PASSWORD }}

    steps:
      # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: npm ci

      # –ö—ç—à –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ Docker Compose
      - name: Ensure Docker Compose (plugin)
        run: |
          if ! docker compose version &>/dev/null; then
            sudo apt-get update
            sudo apt-get install -y docker-compose-plugin
          fi
          docker compose version

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –¥–ª—è Playwright
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Biome)
      - name: Code quality (Biome lint & format check)
        run: npm run check

      # –õ–∏–Ω—Ç–∏–Ω–≥ —Ç–µ—Å—Ç–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª (ESLint)
      - name: Test code quality & architecture rules (ESLint)
        run: npm run lint:tests

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript
      - name: Type check
        run: npm run type-check

      # –ó–∞–ø—É—Å–∫ GrowthBook –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: Start GrowthBook
        run: npm run docker:up
        timeout-minutes: 5

      # –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GrowthBook API
      - name: Wait for API
        run: |
          echo "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ GrowthBook API..."
          for i in {1..30}; do
            if curl -s -f -X POST http://localhost:3100/auth/refresh > /dev/null 2>&1; then
              echo "‚úÖ API –≥–æ—Ç–æ–≤!"
              exit 0
            fi
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ 30..."
            sleep 2
          done
          echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
          npm run docker:logs
          exit 1

      # –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤
      - name: Run full test suite
        run: npm run test -- --project=chromium
        continue-on-error: true

      # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–π—Å–æ–≤ Playwright
      - name: Upload Playwright traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-main-${{ github.run_number }}
          path: test-results
          retention-days: 30

      # –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Allure
      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-full
          path: allure-results
          retention-days: 30

      # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ GrowthBook —Å –æ—á–∏—Å—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
      - name: Stop and cleanup Docker
        if: always()
        run: npm run docker:reset