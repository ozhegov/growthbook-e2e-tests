name: E2E Regression (cron)

on:
  schedule:
    - cron: '0 0 * * *' # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
  workflow_dispatch:

jobs:
  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    env:
      BASE_URL: http://localhost:3000
      API_BASE_URL: http://localhost:3100
      STORAGE_DIR: storage
      RUN_ID: ${{ github.run_number }}

      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      ENGINEER_PASSWORD: ${{ secrets.ENGINEER_PASSWORD }}
      EXPERIMENTER_PASSWORD: ${{ secrets.EXPERIMENTER_PASSWORD }}

    steps:
      # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: npm ci

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –¥–ª—è Playwright
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞ (Biome)
      - name: Lint code
        run: npm run check

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript
      - name: Type check
        run: npm run type-check

      # –ó–∞–ø—É—Å–∫ GrowthBook –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: Start GrowthBook
        run: npm run docker:up

      # –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GrowthBook API
      - name: Wait for API
        run: |
          echo "üîÑ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ GrowthBook API..."
          for i in {1..30}; do
            if curl -s -f http://localhost:3100/auth/refresh > /dev/null 2>&1; then
              echo "‚úÖ API –≥–æ—Ç–æ–≤!"
              exit 0
            fi
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ 30..."
            sleep 2
          done
          echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
          npm run docker:logs
          exit 1

      # –ó–∞–ø—É—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤
      - name: Run regression test suite
        run: npm run test:regression
        continue-on-error: true

      # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–π—Å–æ–≤ Playwright
      - name: Upload Playwright traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-regression-${{ github.run_number }}
          path: test-results
          retention-days: 14

      # –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Allure
      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-regression
          path: allure-results
          retention-days: 60

      # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ GitHub Pages
      - name: Clone gh-pages branch
        if: always()
        run: |
          git clone --depth 1 --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} gh-pages || true

      # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
      - name: Fix permissions on allure-results
        if: always()
        run: sudo chmod -R 777 allure-results

      # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç—á–µ—Ç–∞
      - name: Restore history from previous report
        if: always()
        run: |
          if [ -d gh-pages/allure-report/history ]; then
            mkdir -p allure-results/history
            cp -r gh-pages/allure-report/history/* allure-results/history/
          fi

      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞ Allure
      - name: Generate Allure report
        if: always()
        run: allure generate allure-results -o allure-report --clean

      # –í—ã–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –Ω–∞ GitHub Pages
      - name: Deploy Allure report to GitHub Pages
        if: always()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          cd gh-pages
          rm -rf allure-report
          cp -r ../allure-report ./allure-report
          touch .nojekyll

          git add .
          git diff --quiet && echo "No changes to commit" || git commit -m "üöÄ Update Allure report - run #${{ github.run_number }}"
          git push origin gh-pages

      # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ GrowthBook —Å –æ—á–∏—Å—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
      - name: Stop and cleanup Docker
        if: always()
        run: npm run docker:reset